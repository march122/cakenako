;/*FB_PKG_DELIM*/

__d("FtsFetchEbMessagesEndFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("6752");b=d("FalcoLoggerInternal").create("fts_fetch_eb_messages_end",a);e=b;g["default"]=e}),98);
__d("FtsFetchEbMessagesPageEndFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("6753");b=d("FalcoLoggerInternal").create("fts_fetch_eb_messages_page_end",a);e=b;g["default"]=e}),98);
__d("FtsFetchEbMessagesPageStartFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("6754");b=d("FalcoLoggerInternal").create("fts_fetch_eb_messages_page_start",a);e=b;g["default"]=e}),98);
__d("FtsFetchEbMessagesStartFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("6755");b=d("FalcoLoggerInternal").create("fts_fetch_eb_messages_start",a);e=b;g["default"]=e}),98);
__d("FtsFetchOccamThreadsEndFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("6776");b=d("FalcoLoggerInternal").create("fts_fetch_occam_threads_end",a);e=b;g["default"]=e}),98);
__d("FtsFetchOccamThreadsPageEndFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("6777");b=d("FalcoLoggerInternal").create("fts_fetch_occam_threads_page_end",a);e=b;g["default"]=e}),98);
__d("FtsFetchOccamThreadsPageStartFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("6778");b=d("FalcoLoggerInternal").create("fts_fetch_occam_threads_page_start",a);e=b;g["default"]=e}),98);
__d("FtsFetchOccamThreadsStartFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("6779");b=d("FalcoLoggerInternal").create("fts_fetch_occam_threads_start",a);e=b;g["default"]=e}),98);
__d("LSFetchFtsThreads",["LSIssueNewTask"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return d[0]=new c.Map(),d[0].set("timestamp",a[0]),d[0].set("session_id",a[1]),d[1]=c.toJSON(d[0]),c.storedProcedure(b("LSIssueNewTask"),"fts_thread_fetch",c.i64.cast([0,760]),d[1],void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]),void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]))},function(a){return c.resolve(e)}])}a.__sproc_name__="LSFTSThreadsFetchFtsThreadsStoredProcedure";e.exports=a}),null);
__d("LSFetchFtsThreadsStoredProcedure",["LSFetchFtsThreads","cr:8709"],(function(a,b,c,d,e,f,g){function a(a,b){return c("LSFetchFtsThreads")(b.timestamp,b.sessionId,a)}g["default"]=a}),98);
__d("LSIssueFetchAndIndexMessageRangeTask",["LSAppendDataTraceAddon","LSArrayGetObjectAt","LSBase64Encode.nop","LSFlushDataTrace.nop","LSIsEncryptionVersionSecure","LSIsMobileClient","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsIssueFetchAndIndexMessageRangeTaskStoredProcedure] Beginning execution."),c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(e,f){var g=e.done;e=e.value;return g?c.sequence([function(e){return d[9]=new c.Map(),d[9].set("error_code",c.i64.cast([0,1])),d[9].set("error_message",void 0==null?"":void 0),d[9].set("stored_procedure","issueFetchAndIndexMessageRangeTask"),d[10]=new c.Map(),d[10].set("act_thread_id",a[0]),d[10].set("source",c.i64.cast([0,43])),d[10].set("restore_operation_type",c.i64.cast([0,2])),d[10].set("request_id",void 0),d[10].set("device_id",void 0),d[11]=new c.Map(),d[11].set("restore_context",d[10]),d[11].set("failure",d[9]),d[12]=d[11].get("queue_name"),d[11],d[12]!==void 0?d[13]=d[12]:(d[17]=d[11].get("restore_context"),d[11],d[18]=d[17].get("act_thread_id"),d[17],d[13]=["encrypted_backups_restore",":",d[18]].join("")),d[14]=c.toJSON(d[11]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),d[13],c.i64.cast([0,50030]),d[14],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[15]=a[0],a})},function(a){return d[16]="backup not found",d[16]!==void 0?c.sequence([function(a){return d[18]=["[EncryptedBackups][LSEncryptedBackupsIssueFetchAndIndexMessageRangeTaskStoredProcedure] ","",d[16]].join(""),function(a){c.logger(a).mustfix(a)}(d[18]),d[17]=c.createArray(),void 0!==void 0?d[19]=(d[17].push(void 0),d[17]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueFetchAndIndexMessageRangeTaskStoredProcedure",d[16],d[17],c.i64.cast([0,3]))},function(a){return c.sequence([function(a){return void 0!==void 0?c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,85]),c.i64.cast([0,2]),d[18],void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[21]=a[0],a})},function(a){return d[21]?d[22]=!0:d[22]=!1,d[22]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[23]=c.createArray(),void 0!==void 0?d[24]=(d[23].push(void 0),d[23]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[23],c.i64.cast([0,3]))):c.resolve()}]):c.resolve()},function(a){return void 0!==void 0?c.nativeOperation(b("LSFlushDataTrace.nop"),void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[19]=a[0],a})},function(a){return d[19]?d[20]=!0:d[20]=!1,d[20]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[21]=c.createArray(),void 0!==void 0?d[22]=(d[21].push(void 0),d[21]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[21],c.i64.cast([0,3]))):c.resolve()}])}]):c.sequence([function(a){return void 0!==void 0?c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,85]),c.i64.cast([0,2]),["[EncryptedBackups][LSEncryptedBackupsIssueFetchAndIndexMessageRangeTaskStoredProcedure] ","",""].join(""),void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[19]=a[0],a})},function(a){return d[19]?d[20]=!0:d[20]=!1,d[20]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[21]=c.createArray(),void 0!==void 0?d[22]=(d[21].push(void 0),d[21]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[21],c.i64.cast([0,3]))):c.resolve()}]):c.resolve()},function(a){return void 0!==void 0?c.nativeOperation(b("LSFlushDataTrace.nop"),void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[17]=a[0],a})},function(a){return d[17]?d[18]=!0:d[18]=!1,d[18]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[19]=c.createArray(),void 0!==void 0?d[20]=(d[19].push(void 0),d[19]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[19],c.i64.cast([0,3]))):c.resolve()}])},function(a){return d[1]=!1}]):(f=e.item,c.sequence([function(a){return d[16]=f.deviceId,d[15]=f.backupTenancy,d[14]=f.encryptionVersion,d[9]=void 0,c.i64.neq(d[9],void 0)?c.resolve(d[10]=d[9]):c.sequence([function(a){return d[17]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[18]=a[0],a})},function(a){return d[18]?d[27]=(d[17].push(c.i64.cast([0,0])),d[17]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[19]=a[0],a})},function(a){return d[19]?d[27]=(d[17].push(c.i64.cast([0,2])),d[17]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[20]=a[0],a})},function(a){return d[20]?d[27]=(d[17].push(c.i64.cast([0,3])),d[17]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[21]=a[0],a})},function(a){return d[21]?d[27]=(d[17].push(c.i64.cast([0,4])),d[17]):0,d[22]=c.createArray(),d[23]=c.i64.of_int32(d[17].length),c.i64.gt(d[23],c.i64.cast([0,0]))?c.loopAsync(d[23],function(a){return d[27]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[17],d[27]).then(function(a){return a=a,d[28]=a[0],d[29]=a[1],a})},function(a){return d[30]=(d[22].push(d[28]),d[22])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[27]=c.createArray(),d[28]=c.i64.of_int32(d[22].length),c.i64.gt(d[28],c.i64.cast([0,0]))?c.loopAsync(d[28],function(a){return d[30]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[22],d[30]).then(function(a){return a=a,d[31]=a[0],d[32]=a[1],a})},function(a){return d[33]=(d[27].push(c.i64.to_string(d[31])),d[27])}])}):c.resolve()},function(a){return d[29]=d[27].join(","),d[24]=d[29]}])},function(a){return d[22].some(function(a){return c.i64.eq(d[14],a)})?d[25]=d[14]:d[25]=void 0,c.i64.neq(d[25],void 0)?d[26]=d[25]:d[26]=void 0,d[10]=d[26]}])},function(e){return c.i64.neq(d[10],void 0)?d[11]=d[10]:d[11]=c.i64.cast([0,0]),c.i64.neq(d[15],void 0)?d[12]=d[15]:d[12]=c.i64.cast([0,1]),c.i64.neq(d[16],void 0)?c.sequence([function(a){return c.i64.eq(d[12],c.i64.cast([0,3]))?d[17]=c.i64.cast([0,4]):d[17]=c.i64.cast([0,0]),c.nativeOperation(b("LSBase64Encode.nop"),f.ocmfClientStateBlob).then(function(a){return a=a,d[18]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),f.mailboxRootKeyBlob).then(function(a){return a=a,d[19]=a[0],a})},function(a){return d[20]=new c.Map(),d[20].set("ocmf_client_state_blob",d[18]==null?"":d[18]),d[20].set("mailbox_root_key",d[19]==null?"":d[19]),d[21]=c.createArray(),c.forEach(c.filter(c.db.table(169).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),function(a){a=a.item;return d[34]=(d[21].push(a.epochId),d[21])})},function(a){return d[32]="Queried locally available epochs. Count: ",d[22]=c.i64.of_int32(d[21].length),d[33]=c.i64.to_string(d[22]),d[23]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][MEBEpochClientUtils] ",d[23],d[32],d[23],d[33]].join("")),c.resolve()},function(e){return d[24]=new c.Map(),d[24].set("device_id",d[16]),d[24].set("raw_tokens",d[20]),d[24].set("locally_available_epochs",d[21]),d[25]=new c.Map(),d[25].set("act_thread_id",a[0]),d[25].set("request_id",a[3]),d[25].set("tam_thread_subtype",d[17]),d[25].set("source",c.i64.cast([0,43])),d[26]=new c.Map(),d[26].set("reference_timestamp",a[2]),d[26].set("direction",c.i64.cast([0,1])),d[26].set("server_thread_key",void 0),d[26].set("device_context",d[24]),d[26].set("source",c.i64.cast([0,43])),d[27]=new c.Map(),d[27].set("restore_context",d[25]),d[27].set("success",d[26]),d[28]=d[27].get("queue_name"),d[27],d[28]!==void 0?d[29]=d[28]:(d[34]=d[27].get("restore_context"),d[27],d[35]=d[34].get("act_thread_id"),d[34],d[29]=["encrypted_backups_restore",":",d[35]].join("")),d[30]=c.toJSON(d[27]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),d[29],c.i64.cast([0,50030]),d[30],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[31]=a[0],a})},function(a){return d[13]=!0}]):c.sequence([function(e){return d[17]=new c.Map(),d[17].set("error_code",c.i64.cast([0,1])),d[17].set("error_message",void 0==null?"":void 0),d[17].set("stored_procedure","issueFetchAndIndexMessageRangeTask"),d[18]=new c.Map(),d[18].set("act_thread_id",a[0]),d[18].set("source",c.i64.cast([0,43])),d[18].set("restore_operation_type",c.i64.cast([0,2])),d[18].set("request_id",void 0),d[18].set("device_id",void 0),d[19]=new c.Map(),d[19].set("restore_context",d[18]),d[19].set("failure",d[17]),d[20]=d[19].get("queue_name"),d[19],d[20]!==void 0?d[21]=d[20]:(d[25]=d[19].get("restore_context"),d[19],d[26]=d[25].get("act_thread_id"),d[25],d[21]=["encrypted_backups_restore",":",d[26]].join("")),d[22]=c.toJSON(d[19]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),d[21],c.i64.cast([0,50030]),d[22],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[23]=a[0],a})},function(a){return d[24]="backup not found",d[24]!==void 0?c.sequence([function(a){return d[26]=["[EncryptedBackups][LSEncryptedBackupsIssueFetchAndIndexMessageRangeTaskStoredProcedure] ","",d[24]].join(""),function(a){c.logger(a).mustfix(a)}(d[26]),d[25]=c.createArray(),void 0!==void 0?d[27]=(d[25].push(void 0),d[25]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueFetchAndIndexMessageRangeTaskStoredProcedure",d[24],d[25],c.i64.cast([0,3]))},function(a){return c.sequence([function(a){return void 0!==void 0?c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,85]),c.i64.cast([0,2]),d[26],void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[29]=a[0],a})},function(a){return d[29]?d[30]=!0:d[30]=!1,d[30]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[31]=c.createArray(),void 0!==void 0?d[32]=(d[31].push(void 0),d[31]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[31],c.i64.cast([0,3]))):c.resolve()}]):c.resolve()},function(a){return void 0!==void 0?c.nativeOperation(b("LSFlushDataTrace.nop"),void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[27]=a[0],a})},function(a){return d[27]?d[28]=!0:d[28]=!1,d[28]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[29]=c.createArray(),void 0!==void 0?d[30]=(d[29].push(void 0),d[29]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[29],c.i64.cast([0,3]))):c.resolve()}])}]):c.sequence([function(a){return void 0!==void 0?c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,85]),c.i64.cast([0,2]),["[EncryptedBackups][LSEncryptedBackupsIssueFetchAndIndexMessageRangeTaskStoredProcedure] ","",""].join(""),void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[27]=a[0],a})},function(a){return d[27]?d[28]=!0:d[28]=!1,d[28]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[29]=c.createArray(),void 0!==void 0?d[30]=(d[29].push(void 0),d[29]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[29],c.i64.cast([0,3]))):c.resolve()}]):c.resolve()},function(a){return void 0!==void 0?c.nativeOperation(b("LSFlushDataTrace.nop"),void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[25]=a[0],a})},function(a){return d[25]?d[26]=!0:d[26]=!1,d[26]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[27]=c.createArray(),void 0!==void 0?d[28]=(d[27].push(void 0),d[27]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[27],c.i64.cast([0,3]))):c.resolve()}])},function(a){return d[13]=!1}])},function(a){return d[1]=d[13]}]))})},function(a){return d[3]=c.i64.of_float(Date.now()),d[4]=c.i64.random(),d[6]="Finishing execution. Execution time: ",d[7]=c.i64.to_string(c.i64.sub(d[3],d[0])),d[8]=" ms",d[5]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsIssueFetchAndIndexMessageRangeTaskStoredProcedure] ",d[5],d[6],d[5],d[7],d[5],d[8]].join("")),c.i64.eq(c.i64.mod_(d[4],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[9]=",",d[10]=c.createArray(),void 0!==void 0?d[11]=(d[10].push(void 0),d[10]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueFetchAndIndexMessageRangeTaskStoredProcedure",[d[6],d[9],d[7],d[9],d[8]].join(""),d[10],c.i64.cast([0,4]))):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsIssueFetchAndIndexMessageRangeTaskStoredProcedure";e.exports=a}),null);
__d("LSIssueFetchAndIndexMessageRangeTaskStoredProcedure",["LSIssueFetchAndIndexMessageRangeTask","cr:8709"],(function(a,b,c,d,e,f,g){function a(a,b){return c("LSIssueFetchAndIndexMessageRangeTask")(b.threadId,b.numMessages,b.startSortKey,b.traceId,a)}g["default"]=a}),98);
__d("MAWFTSEncryptedBackupLightweightRestore",["I64","LSEncryptedBackupsBackupTenancy","LSFactory","LSIntEnum","LSIssueFetchAndIndexMessageRangeTaskStoredProcedure","LSMEBTaskCreationSource","MAWAsyncEBPendingQueryPromise","MAWBridgeSendAndReceive","MAWEBRestoreTrackingUtils","MAWEncryptedBackupUtils","MAWMainTraceUtils","MWEncryptedBackUpEBNotEnabledError","Promise","emptyFunction","err","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function a(a,e,g,k,l,m){l===void 0&&(l=c("emptyFunction"));if(!c("gkx")("23914"))return null;var n=d("MAWMainTraceUtils").createTraceId();c("promiseDone")(d("MAWEncryptedBackupUtils").getBackupTenancy(a.tables).then(function(o){if(o==null||!(i||(i=d("I64"))).equal(o,(j||(j=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsBackupTenancy").PRODUCTION))){d("MAWAsyncEBPendingQueryPromise").rejectPendingQueryIfPresent(n,c("err")(d("MWEncryptedBackUpEBNotEnabledError").EB_NOT_ENABLED));return(h||(h=b("Promise"))).resolve()}l();return c("gkx")("7441")?d("MAWBridgeSendAndReceive").sendAndReceive("backend","issueGraphQLRangeRestoreRequest",{chatJid:m,direction:"before",sortOrderMs:g!=null?g:void 0,source:c("LSMEBTaskCreationSource").FTS_INDEX_EB_MESSAGES_WEB,threadId:e,traceId:n}).then(function(a){if(a.loadMessagesResponse!=null)d("MAWAsyncEBPendingQueryPromise").resolvePendingQueryIfPresent(n,a.loadMessagesResponse);else{d("MAWAsyncEBPendingQueryPromise").rejectPendingQueryIfPresent(n,c("err")((a=a.error)!=null?a:"Error restoring from EB over graphQL in worker"))}return(h||(h=b("Promise"))).resolve()}):a.runInTransaction(function(a){d("MAWEBRestoreTrackingUtils").markEBRestoreSearch({querySource:"LS",traceId:n});return c("LSIssueFetchAndIndexMessageRangeTaskStoredProcedure")(c("LSFactory")(a),{numMessages:k,startSortKey:g==null?void 0:g,threadId:e,traceId:n})},"readwrite",void 0,void 0,f.id+":91")}));return n}g.runQuery=a}),98);
__d("MAWAsyncEBIssueFetchAndIndexFTSQuery",["MAWAsyncEBPendingQueryPromise","MAWFTSEncryptedBackupLightweightRestore","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e,f){f===void 0&&(f=function(){});var g=d("WAJids").threadIdForChatJid(b);a=d("MAWFTSEncryptedBackupLightweightRestore").runQuery(a,g,c,e,f,b);if(a==null)return null;d("MAWAsyncEBPendingQueryPromise").setJidFromThreadId(g,b);return{promise:d("MAWAsyncEBPendingQueryPromise").getPendingQueryPromiseFromTrace(a),traceId:a}}g.issueQueryAsPromise=a}),98);
__d("MAWFTSRestoreCap",["WATimeUtils","justknobx","qex"],(function(a,b,c,d,e,f,g){"use strict";b=c("justknobx")._("1658");f=(e=c("qex")._("924"))!=null?e:b;c=d("WATimeUtils").DAY_MILLISECONDS*f;var h=Date.now()-c;function a(a){return a>h}g.RESTORE_CAP_DATE_MS=h;g.isRestoreTimeWithinCap=a}),98);
__d("MAWMediaGalleryBufferAndRestore",[],(function(a,b,c,d,e,f){"use strict";var g=null,h=[],i=[],j=null,k=2e3,l=10;function a(a,b,c,d,e,f,m,n,o){var p=function(){var g;h=h.concat(b);i=i.concat((g=c)!=null?g:[]);h.length>=l?(void o(a,h,i,d,e,f,m,n),h=[],i=[]):j=window.setTimeout(function(){var b=[].concat(h),c=[].concat(i);void o(a,b,c,d,e,f,m,n);h=[];i=[]},k)},q=function(){window.clearTimeout(j);var a=h.map(function(a){return a}),b=i.map(function(a){return a});g!=null&&void o(g,a,b,d,e,f,m,n);h=[];i=[]};if(a!==g){q();g=a;p();return}if(h.length===0)p();else{h=h.concat(b);i=i.concat((p=c)!=null?p:[]);h.length>=l&&q()}}f.bufferAndRestoreProtobuf=a}),66);
__d("MWMediaRestoreStatus",["I64","LSDatabaseSingleton","MAWChatJid","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j={mediaCount:0,messageCount:0,threadId:(h||(h=d("I64"))).zero};function a(a,b,c){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){var e=(yield (i||(i=d("LSDatabaseSingleton"))).LSDatabaseSingleton);e=(yield e.runInTransaction(function(b){return d("MAWChatJid").toThreadKeyMaybeForChatJidInteger(b,(h||(h=d("I64"))).of_string(a))},"readwrite",void 0,void 0,f.id+":35"));if(j.threadId===e)j.messageCount+=b,j.mediaCount+=c;else{j.messageCount=b;j.mediaCount=c;j.threadId=(b=e)!=null?b:(h||(h=d("I64"))).zero}});return k.apply(this,arguments)}function c(){return j}g.updateRestoreStatus=a;g.getRestoreStatus=c}),98);
__d("MAWMediaGalleryRestoreSync",["CurrentUser","EchoMessage","I64","LSDatabaseSingleton","LSIntEnum","LSMEBTaskCreationSource","LSThreadMediaGalleryGroup","MAWChatJid","MAWFTSRestoreSync","MAWHandleEchoProtobufsRestoreApi","MAWJids","MAWJobDefinitions","MAWMediaGalleryBufferAndRestore","MAWMediaGalleryM2Utils","MAWRestoreMessagesFromEncryptedBackupsDeferred","MAWRestoreProtobufsFromEncryptedBackupsDeferred","MWMediaRestoreStatus","Promise","ReQL","WAJobOrchestratorTypes","WALogger","WAMsgType","asyncToGeneratorRuntime","justknobx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k;function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore RestoreType is none"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore Protobuf error: ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore Protobuf error: ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore: protobufMessages is null"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore Echo error: ",""]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore: echoMessages is null"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore: threadId is null"]);r=function(){return a};return a}var s=c("justknobx")._("3060");function a(a,b){return t.apply(this,arguments)}function t(){t=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e){var g=a.echoMessages,j=a.hasMoreAfter,t=a.hasMoreBefore,v=a.isPointQuery,w=a.protobufMessages,x=a.referenceTimestamp,y=a.requestId,z=a.restoreType,A=a.threadId;if(A==null){e==null?void 0:e.endFailure("threadId is null");d("WALogger").ERROR(r());return}e==null?void 0:e.addAnnotations({string:{restore_type:z}});e==null?void 0:e.addPoint("handle_media_restore_sync_start");if(z==="echo"){if(g==null){e==null?void 0:e.endFailure("echoMessages is null");d("WALogger").ERROR(q());return}e==null?void 0:e.addPoint("messages_decoding_and_filtering_start");a=g.filter(function(a){a=d("EchoMessage").decodeEchoMessage(a);return(a==null?void 0:a.contentType)===d("EchoMessage").EchoMessageContentType.MEDIA});e==null?void 0:e.addPoint("messages_decoding_and_filtering_end");a.length>0&&s&&d("MAWFTSRestoreSync").MAWGalleryEventEmitter.emit("isPersisting",!0);e==null?void 0:e.addAnnotations({"int":{media_count:a.length,message_count:g.length}});e==null?void 0:e.addPoint("update_media_restore_status_start");yield d("MWMediaRestoreStatus").updateRestoreStatus(A,g.length,a.length);e==null?void 0:e.addPoint("update_media_restore_status_end");e==null?void 0:e.addPoint("restore_messages_in_worker_start");c("promiseDone")(d("MAWRestoreMessagesFromEncryptedBackupsDeferred").call("AdvancedCrypto",d("MAWJobDefinitions").toThreadJidPrimaryId(A),a.map(d("MAWJobDefinitions").toEncodedEchoMessage),t,void 0,j,void 0,v,y,x,c("LSMEBTaskCreationSource").FTS_INDEX_EB_MESSAGES_WEB,!0,c("justknobx")._("3213")?d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW:d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION)["catch"](function(a){e==null?void 0:e.endFailure(a),d("WALogger").ERROR(p(),a)}),function(){e==null?void 0:e.addPoint("restore_messages_in_worker_end"),s?(e==null?void 0:e.addPoint("restore_messages_update_ranges_start"),c("promiseDone")((i||(i=d("LSDatabaseSingleton"))).LSDatabaseSingleton.then(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){e==null?void 0:e.addPoint("update_range_get_thread_key_start");var g=(yield a.runInTransaction(function(a){return d("MAWChatJid").toThreadKeyMaybeForChatJidInteger(a,(k||(k=d("I64"))).of_string(A))},"readonly",void 0,void 0,f.id+":144"));e==null?void 0:e.addPoint("update_range_get_thread_key_end");if(!g){e==null?void 0:e.addPoint("restore_messages_update_ranges_end",{bool:{is_updated:!1}});return}return(h||(h=b("Promise"))).all([u(a,g,c("LSThreadMediaGalleryGroup").PHOTOS_AND_VIDEOS),u(a,g,c("LSThreadMediaGalleryGroup").FILES_ONLY)])});return function(b){return a.apply(this,arguments)}}()).then(function(){d("MAWFTSRestoreSync").MAWGalleryEventEmitter.emit("isPersisting",!1),e==null?void 0:e.addPoint("restore_messages_update_ranges_end",{bool:{is_updated:!0}}),e==null?void 0:e.addPoint("handle_media_restore_sync_end"),e==null?void 0:e.endSuccess()}))):(e==null?void 0:e.addPoint("handle_media_restore_sync_end"),e==null?void 0:e.endSuccess())})}else if(z==="protobuf"){if(w==null){e==null?void 0:e.endFailure("protobufMessages is null");d("WALogger").ERROR(o());return}e==null?void 0:e.addPoint("get_user_jid_start");var B=d("MAWJids").toUserJid(c("CurrentUser").getAccountID());e==null?void 0:e.addPoint("get_user_jid_end");e==null?void 0:e.addPoint("messages_decoding_and_filtering_start");a=w.filter(function(a){a=d("MAWHandleEchoProtobufsRestoreApi").decodeDecryptedMessageProtobuf(a,B,void 0,new Set(),new Set(),new Map(),new Map(),new Map(),!0);return a.msgType===d("WAMsgType").MSG_TYPE.IMAGE||a.msgType===d("WAMsgType").MSG_TYPE.VIDEO||a.msgType===d("WAMsgType").MSG_TYPE.DOCUMENT_FILE&&d("MAWMediaGalleryM2Utils").isFilesEBRestoreEnabled()});e==null?void 0:e.addPoint("messages_decoding_and_filtering_end");a.length>0&&s&&d("MAWFTSRestoreSync").MAWGalleryEventEmitter.emit("isPersisting",!0);e==null?void 0:e.addAnnotations({"int":{media_count:a.length,message_count:w.length}});e==null?void 0:e.addPoint("update_media_restore_status_start");yield d("MWMediaRestoreStatus").updateRestoreStatus(A,w.length,a.length);e==null?void 0:e.addPoint("update_media_restore_status_end");e==null?void 0:e.addPoint("restore_messages_in_worker_start");if(c("justknobx")._("3248")){z=function(a,g,j,l,m,o,p,q){c("promiseDone")(d("MAWRestoreProtobufsFromEncryptedBackupsDeferred").call("AdvancedCrypto",d("MAWJobDefinitions").toThreadJidPrimaryId(a),g,l,void 0,m,void 0,o,p,q,void 0,j,(k||(k=d("I64"))).of_int32(c("LSMEBTaskCreationSource").FTS_INDEX_EB_MESSAGES_WEB),!0,c("justknobx")._("3213")?d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW:d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION)["catch"](function(a){e==null?void 0:e.endFailure(a),d("WALogger").ERROR(n(),a)}),function(){e==null?void 0:e.addPoint("restore_messages_in_worker_end"),s?(e==null?void 0:e.addPoint("restore_messages_update_ranges_start"),c("promiseDone")((i||(i=d("LSDatabaseSingleton"))).LSDatabaseSingleton.then(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){e==null?void 0:e.addPoint("update_range_get_thread_key_start");var g=(yield a.runInTransaction(function(a){return d("MAWChatJid").toThreadKeyMaybeForChatJidInteger(a,(k||(k=d("I64"))).of_string(A))},"readonly",void 0,void 0,f.id+":292"));e==null?void 0:e.addPoint("update_range_get_thread_key_end");if(!g){e==null?void 0:e.addPoint("restore_messages_update_ranges_end",{bool:{is_updated:!1}});return}return(h||(h=b("Promise"))).all([u(a,g,c("LSThreadMediaGalleryGroup").PHOTOS_AND_VIDEOS),u(a,g,c("LSThreadMediaGalleryGroup").FILES_ONLY)])});return function(b){return a.apply(this,arguments)}}()).then(function(){d("MAWFTSRestoreSync").MAWGalleryEventEmitter.emit("isPersisting",!1),e==null?void 0:e.addPoint("restore_messages_update_ranges_end",{bool:{is_updated:!0}}),e==null?void 0:e.addPoint("handle_media_restore_sync_end"),e==null?void 0:e.endSuccess()}))):(e==null?void 0:e.addPoint("handle_media_restore_sync_end"),e==null?void 0:e.endSuccess())})};d("MAWMediaGalleryBufferAndRestore").bufferAndRestoreProtobuf(A,a,g,t,j,v,y,x,z)}else c("promiseDone")(d("MAWRestoreProtobufsFromEncryptedBackupsDeferred").call("AdvancedCrypto",d("MAWJobDefinitions").toThreadJidPrimaryId(A),a,t,void 0,j,void 0,v,y,x,void 0,g,(k||(k=d("I64"))).of_int32(c("LSMEBTaskCreationSource").FTS_INDEX_EB_MESSAGES_WEB),!0,c("justknobx")._("3213")?d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW:d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION)["catch"](function(a){e==null?void 0:e.endFailure(a),d("WALogger").ERROR(m(),a)}),function(){e==null?void 0:e.addPoint("restore_messages_in_worker_end"),s?(e==null?void 0:e.addPoint("restore_messages_update_ranges_start"),c("promiseDone")((i||(i=d("LSDatabaseSingleton"))).LSDatabaseSingleton.then(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){e==null?void 0:e.addPoint("update_range_get_thread_key_start");var g=(yield a.runInTransaction(function(a){return d("MAWChatJid").toThreadKeyMaybeForChatJidInteger(a,(k||(k=d("I64"))).of_string(A))},"readonly",void 0,void 0,f.id+":383"));e==null?void 0:e.addPoint("update_range_get_thread_key_end");if(!g){e==null?void 0:e.addPoint("restore_messages_update_ranges_end",{bool:{is_updated:!1}});return}return(h||(h=b("Promise"))).all([u(a,g,c("LSThreadMediaGalleryGroup").PHOTOS_AND_VIDEOS),u(a,g,c("LSThreadMediaGalleryGroup").FILES_ONLY)])});return function(b){return a.apply(this,arguments)}}()).then(function(){d("MAWFTSRestoreSync").MAWGalleryEventEmitter.emit("isPersisting",!1),e==null?void 0:e.addPoint("restore_messages_update_ranges_end",{bool:{is_updated:!0}}),e==null?void 0:e.addPoint("handle_media_restore_sync_end"),e==null?void 0:e.endSuccess()}))):(e==null?void 0:e.addPoint("handle_media_restore_sync_end"),e==null?void 0:e.endSuccess())})}else e==null?void 0:e.endFailure("RestoreType is none"),d("WALogger").ERROR(l())});return t.apply(this,arguments)}function u(a,c,e){return a.runInTransaction(function(){var f=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var f=(yield d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.tables.attachments_ranges_v2__generated).getKeyRange(c).filter(function(a){return(k||(k=d("I64"))).equal(a.mediaGroup,(j||(j=d("LSIntEnum"))).ofNumber(e))})));if(f==null||(f==null?void 0:f.hasMoreBefore)===!0)return;var g=babelHelpers["extends"]({},f,{hasMoreBefore:!0});return b.attachments_ranges_v2__generated.upsert([f.threadKey,f.mediaGroup,f.minTimestampMs],g)});return function(a){return f.apply(this,arguments)}}(),"readwrite","ui",void 0,f.id+":443")}g.handleMediaRestoreSync=a}),98);
__d("MAWFTSRestoreSyncLogger",["FtsFetchEbMessagesEndFalcoEvent","FtsFetchEbMessagesPageEndFalcoEvent","FtsFetchEbMessagesPageStartFalcoEvent","FtsFetchEbMessagesStartFalcoEvent","FtsFetchOccamThreadsEndFalcoEvent","FtsFetchOccamThreadsPageEndFalcoEvent","FtsFetchOccamThreadsPageStartFalcoEvent","FtsFetchOccamThreadsStartFalcoEvent","MAWBridgeSendAndReceive","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h=new Set(),i=new Set(),j=null,k=!1,l=0,m=0;function a(){return n.apply(this,arguments)}function n(){n=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(j!=null&&j!=="")return;j=(yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchGetFTSRestoreSessionId"))});return n.apply(this,arguments)}function e(a,b,d){if(!b||i.has(a)){i.add(a);return}h.has(a)||(h.add(a),d&&c("FtsFetchEbMessagesStartFalcoEvent").log(function(){var a;return{app_name:"",session_id:(a=j)!=null?a:""}}));c("FtsFetchEbMessagesPageStartFalcoEvent").log(function(){var a;return{app_name:"",session_id:(a=j)!=null?a:""}})}function f(a,b,d){if(i.has(a)||!h.has(a))return;c("FtsFetchEbMessagesPageEndFalcoEvent").log(function(){var a;return{app_name:"",messages_count:b.toString(),session_id:(a=j)!=null?a:""}});d||(i.add(a),c("FtsFetchEbMessagesEndFalcoEvent").log(function(){var a;return{app_name:"",duration:0,session_id:(a=j)!=null?a:"",total_messages_count:"0"}}))}function o(a){if(i.has(a)||!h.has(a))return;c("FtsFetchEbMessagesPageEndFalcoEvent").log(function(){var a;return{app_name:"",messages_count:"0",session_id:(a=j)!=null?a:""}})}function p(){c("FtsFetchOccamThreadsEndFalcoEvent").log(function(){var a;return{app_name:"",duration:0,remaining_threads_count:m.toString(),session_id:(a=j)!=null?a:"",total_threads_count:l.toString()}})}function q(){k||(k=!0,c("FtsFetchOccamThreadsStartFalcoEvent").log(function(){var a;return{app_name:"",session_id:(a=j)!=null?a:""}})),c("FtsFetchOccamThreadsPageStartFalcoEvent").log(function(){var a;return{app_name:"",session_id:(a=j)!=null?a:""}})}function r(a){c("FtsFetchOccamThreadsPageEndFalcoEvent").log(function(){var b;return{app_name:"",session_id:(b=j)!=null?b:"",thread_count:a.toString()}})}function s(a){l++,a||m++}g.initLoggingSessionId=a;g.onFetchMessagePageStart=e;g.onFetchMessagePageComplete=f;g.onFetchMessagePageFailed=o;g.onFetchThreadsComplete=p;g.onFetchThreadsPageStart=q;g.onFetchThreadsPageComplete=r;g.incrementTotalResultCount=s}),98);
__d("MWMediaRestoreQplUtils",["MAWLoggerUtils","MAWMediaGalleryM2Utils","QPLUserFlow","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h=18e4;function i(a){var b=d("MAWLoggerUtils").getInstanceKey();return{addAnnotations:function(d){c("QPLUserFlow").addAnnotations(a,d,{instanceKey:b})},addPoint:function(d,e){c("QPLUserFlow").addPoint(a,d,{data:e,instanceKey:b})},endCancel:function(d){c("QPLUserFlow").endCancel(a,{cancelReason:d,instanceKey:b})},endFailure:function(d){c("QPLUserFlow").endFailure(a,d,{instanceKey:b})},endSuccess:function(){c("QPLUserFlow").endSuccess(a,{instanceKey:b})},start:function(){c("QPLUserFlow").start(a,{instanceKey:b,timeoutInMs:h})}}}function a(){var a=d("MAWMediaGalleryM2Utils").isMediaGalleryM2Enabled(),b=c("qpl")._(25304794,"2287");return a?i(b):null}function b(){var a=c("qpl")._(25306381,"2492");return i(a)}g.createMediaRestoreBatchQPLFlow=a;g.createMediaRestoreLoadAllQPLFlow=b}),98);
__d("MAWFTSRestoreSync",["EventEmitter","FBLogger","I64","LSDatabaseSingleton","MAWAsyncEBIssueFetchAndIndexFTSQuery","MAWBridgeSearchMsg","MAWBridgeSendAndReceive","MAWFTSRestoreCap","MAWFTSRestoreSyncLogger","MAWLoggerUtils","MAWMediaGalleryM2Utils","MAWMediaGalleryRestoreSync","MWEncryptedBackUpEBNotEnabledError","MWMediaRestoreQplUtils","Promise","QPLUserFlow","WAPromiseDelays","WAResultOrError","asyncToGeneratorRuntime","cr:10453","gkx","justknobx","promiseDone","qpl","uuidv4"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k=new(c("EventEmitter"))(),l=(i||(i=d("I64"))).of_int32(c("justknobx")._("2477")),m=c("gkx")("6065")?c("justknobx")._("2927"):c("justknobx")._("2606"),n=c("uuidv4")();function o(){window.setInterval(function(){c("promiseDone")(d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSReportTabAlive",{hasFocus:document.hasFocus(),tabId:n},{isLoggingDisabled:!0}))},1e3)}function p(a){return q.apply(this,arguments)}function q(){q=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSReportTabTaskComplete",{error:a,tabId:n})});return q.apply(this,arguments)}function r(){return s.apply(this,arguments)}function s(){s=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSReportTabDestroy",{tabId:n})});return s.apply(this,arguments)}var t=function(){var e=a.prototype;e.setIsStarted=function(a){this.$1=a,k.emit("isSyncStarted",a)};e.setIsEBMaybeAvailable=function(a){this.$4=a,k.emit("isEBMaybeAvailable",a)};e.setActiveThreadId=function(a){b("cr:10453")!=null&&(a!=null&&b("cr:10453").getInstance().insertIntoHead(a)),this.$5=a,k.emit("activeThreadJid",a)};e.setShouldPauseRestore=function(a){this.$3=a};e.removeFromQueue=function(a){b("cr:10453")!=null&&a!=null&&b("cr:10453").getInstance().removeThread(a)};e.getActiveThreadId=function(){return this.$5};e.getNextThreadIdToFetch=function(){return b("cr:10453")!=null?b("cr:10453").getInstance().getThreadsHead():this.getActiveThreadId()};e.getDoneThreads=function(){return this.$7};e.isStarted=function(){return this.$1};e.isEBMaybeAvailable=function(){return this.$4};e.resetEBAvailability=function(){this.setIsEBMaybeAvailable(!0)};e.registerNewMessagesListener=function(a,b){this.$6[a]=b};e.removeNewMessagesListener=function(a){delete this.$6[a]};e.$8=function(a,b){var c=this;Object.keys(this.$6).forEach(function(d){c.$6[d](a,b)})};e.$9=function(a,c,e){return a!==c&&b("cr:10453")!=null?e==null||d("MAWFTSRestoreCap").isRestoreTimeWithinCap(parseInt(e,10)):e!=="0"};e.startSyncingLoop=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=this;if(this.$1||this.$4===!1)return;this.setIsStarted(!0);this.setShouldPauseRestore(!1);yield d("MAWFTSRestoreSyncLogger").initLoggingSessionId();yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSReportTabForeground",{tabId:n},{isLoggingDisabled:!0});window.addEventListener("focus",b("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSReportTabForeground",{tabId:n},{isLoggingDisabled:!0})}));o();var e=0,f=null,g=function*(){var g,o=a.getNextThreadIdToFetch(),q=a.getActiveThreadId();f!==o&&(f=o,e=0);if(o==null||b("cr:10453")==null&&a.$7.has(o)){yield d("WAPromiseDelays").delayMs(200);return"continue"}if(a.$3){yield d("WAPromiseDelays").delayMs(200);return"continue"}var s=(yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSGetThreadRestoreStatus",{threadId:o},{isLoggingDisabled:!0})),t=(g=s==null?void 0:s.restoredUntilSortOrderMs)!=null?g:null;k.emit("restoredUntilMs",t);var u=s==null||s.restoredUntilSortOrderMs===s.maxRestoredUntilSortOrderMs||s.restoredUntilSortOrderMs==null;g=a.$9(o,q,t);if(!g){t==="0"&&a.$7.add(o);a.removeFromQueue(o);yield d("WAPromiseDelays").delayMs(200);return"continue"}s=(yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSRequestRestoreTask",{tabId:n,threadJid:o}));if(!s){yield d("WAPromiseDelays").delayMs(200);return"continue"}q=(yield (j||(j=d("LSDatabaseSingleton"))).LSDatabaseSingleton);g=d("MAWAsyncEBIssueFetchAndIndexFTSQuery").issueQueryAsPromise(q,o,t,l,function(){d("MAWFTSRestoreSyncLogger").onFetchMessagePageStart(o,t==null||d("MAWFTSRestoreCap").isRestoreTimeWithinCap(parseInt(t,10)),u)});if(g==null){a.setIsEBMaybeAvailable(!1);a.setIsStarted(!1);return{v:(h||(h=b("Promise"))).resolve()}}s=d("MAWLoggerUtils").getInstanceKey();c("QPLUserFlow").start(c("qpl")._(25300854,"2397"),{annotations:{"int":{retryCount:e},string:{restoreUntilMs:(q=t)!=null?q:"",traceId:g.traceId}},instanceKey:s});q=d("MWMediaRestoreQplUtils").createMediaRestoreBatchQPLFlow();var v=d("MAWMediaGalleryM2Utils").isMediaGalleryM2Enabled();q==null?void 0:q.start();q==null?void 0:q.addAnnotations({"int":{retry_count:e}});g=g.promise.then(function(a){return d("WAResultOrError").makeResult(a)});try{g=(yield (h||(h=b("Promise"))).race([g,new h(function(a){return window.setTimeout(function(){return a(d("WAResultOrError").makeError("timeout"))},m)})]));if(g.success===!1){e++;c("QPLUserFlow").endFailure(c("qpl")._(25300854,"2397"),"timeout",{instanceKey:s});q==null?void 0:q.endFailure("timeout");d("MAWFTSRestoreSyncLogger").onFetchMessagePageFailed(o);c("FBLogger")("fts_worker").mustfix("Fail to fetch a new batch of messages due to timeout");return"continue"}e=0;c("QPLUserFlow").endSuccess(c("qpl")._(25300854,"2397"),{instanceKey:s});s=g.value;var w=s.messages;s=s.nextMessageTimestampMsBefore;s=s!=null?(i||(i=d("I64"))).to_string(s):"0";var x=d("MAWFTSRestoreCap").isRestoreTimeWithinCap(parseInt(s,10));d("MAWFTSRestoreSyncLogger").onFetchMessagePageComplete(o,w.length,x);a.$8(o,w);x=w.map(function(a){return d("MAWBridgeSearchMsg").createBridgeSearchMsg(a,o,!1)}).filter(Boolean);v&&(yield d("MAWMediaGalleryRestoreSync").handleMediaRestoreSync(g.value,q));yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchIndexUpdate",{newSortOrderMs:s,threadId:o,unvaultedBridgeSearchMessages:x})}catch(e){if(e&&(e==null?void 0:e.message)===d("MWEncryptedBackUpEBNotEnabledError").EB_NOT_ENABLED){a.setIsEBMaybeAvailable(!1);a.setIsStarted(!1);yield r();return{v:(h||(h=b("Promise"))).resolve()}}d("MAWFTSRestoreSyncLogger").onFetchMessagePageFailed(o);c("FBLogger")("fts_worker").mustfix("Fail to fetch a new batch of messages with error %s",e==null?void 0:e.message);q==null?void 0:q.endFailure((w=e==null?void 0:e.message)!=null?w:"unknown");yield p(e);return"continue"}yield p()};while(this.$2){var q=(yield* g());switch(q){case"continue":continue;default:if(typeof q==="object")return q.v}}});function e(){return a.apply(this,arguments)}return e}();a.getInstance=function(){var b=a.instance;if(b!=null)return b;b=new a();a.instance=b;return b};a.resetInstance=function(){a.instance=null};e.setKeepWhileLoop_FOR_TESTING_ONLY=function(a){this.$2=a};function a(){this.$1=!1,this.$2=!0,this.$3=!1,this.$4=!0,this.$5=void 0,this.$6={},this.$7=new Set(),c("FBLogger")("fts_worker").info("New MAWFTSRestoreSync instance")}return a}();t.instance=null;function a(){return t.getInstance()}g.MAWGalleryEventEmitter=k;g.MAWFTSRestoreSync=t;g.getFTSRestoreSync=a}),98);
__d("ThreadsDoublyLinkedList",[],(function(a,b,c,d,e,f){"use strict";var g=function(a){this.value=a};a=function(){function a(){this.$1=new Map(),this.$2=null,this.$3=null}var b=a.prototype;b.getHead=function(){if(this.$2!=null)return this.$2.value};b.has=function(a){return this.$1.has(a)};b.size=function(){return this.$1.size};b.insertToHead=function(a){if(this.getHead()===a)return;this.has(a)&&this.remove(a);this.$2==null?this.add(a):(this.$2.prev=new g(a),this.$2.prev.next=this.$2,this.$2=this.$2.prev,this.$1.set(a,this.$2))};b.add=function(a){if(this.has(a))return;if(!this.$2){this.$2=new g(a);this.$3=this.$2;this.$1.set(a,this.$2);return}this.$3!=null&&(this.$3.next=new g(a),this.$3.next.prev=this.$3,this.$3=this.$3.next,this.$1.set(a,this.$3))};b.remove=function(a){var b=this.$1.get(a);if(b==null)return;b.prev!=null&&(b.prev.next=b.next);b.next!=null&&(b.next.prev=b.prev);b===this.$2&&(this.$2=b.next);b===this.$3&&(this.$3=b.prev);this.$1["delete"](a)};return a}();f["default"]=a}),66);
__d("MAWFTSThreadsRestore",["FBLogger","I64","LSDatabaseSingleton","LSFactory","LSFetchFtsThreadsStoredProcedure","LSMessagingThreadTypeUtil","MAWBridgeSendAndReceive","MAWFTSRestoreCap","MAWFTSRestoreSyncLogger","MAWJids","ReQL","ThreadsDoublyLinkedList","WAJids","asyncToGeneratorRuntime","emptyFunction","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k=function(){function a(){this.$1=new Map(),this.$4=!1,this.$5=(h||(h=d("I64"))).zero,this.$6=!1,this.$7=new Set(),c("FBLogger")("mw_message_search").info("New MAWFTSThreadsRestore instance"),this.$2=new(c("ThreadsDoublyLinkedList"))()}var e=a.prototype;e.startThreadsRestore=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(this.$4)return;this.$4=!0;this.$6=!0;yield d("MAWFTSRestoreSyncLogger").initLoggingSessionId();yield this.$8();yield this.$9()});function c(){return a.apply(this,arguments)}return c}();e.isThreadQueryInProgress=function(){return this.$6||this.$7.size>0};e.getInitialLastActivityTimeForThreadMs=function(a){return this.$1.get(a)};e.getThreadsHead=function(){return this.$2.getHead()};e.hasThread=function(a){return this.$2.has(a)};e.insertIntoHead=function(a){this.$2.insertToHead(a)};e.removeThread=function(a){this.$2.remove(a)};e.$10=function(a,b){d("MAWFTSRestoreSyncLogger").onFetchThreadsPageStart(),void a.runInTransaction(function(a){return c("LSFetchFtsThreadsStoredProcedure")(c("LSFactory")(a),{sessionId:"",timestamp:b})},"readwrite",void 0,void 0,f.id+":123")};e.$11=function(a,b,e){e===void 0&&(e=c("emptyFunction"));this.$6=!0;var f=b.hasNextPage,g=b.nextPageCursor;b=b.resultCount;b=(h||(h=d("I64"))).to_int32(b);var i=!h.equal(g,this.$5),j=d("MAWFTSRestoreCap").isRestoreTimeWithinCap(h.to_float(g));i&&d("MAWFTSRestoreSyncLogger").onFetchThreadsPageComplete(b);f&&j?i&&(this.$5=g,this.$10(a,g)):(this.$6=!1,this.$7.size===0&&d("MAWFTSRestoreSyncLogger").onFetchThreadsComplete(),e())};e.$8=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=this,b=(yield this.$12()),c=d("ReQL").fromTableAscending(b.tables.messenger_fts_threads_queries,["hasNextPage","nextPageCursor","resultCount"]),e={contents:function(){}};e.contents=c.subscribe(function(c,d){if(d.operation==="delete")return;a.$11(b,d.value,e.contents)});c=(yield d("ReQL").firstAsync(c));c?this.$11(b,c):this.$10(b,(h||(h=d("I64"))).max_int)});function c(){return a.apply(this,arguments)}return c}();e.$13=function(a){var b=this,e=a.nextMessageTimestamp,f=a.threadId;a=a.threadType;f=(h||(h=d("I64"))).to_string(f);a=d("LSMessagingThreadTypeUtil").isGroup(a);var g=a?d("WAJids").toGroupJid(f):d("MAWJids").toUserJid(f);this.$7.add(g);c("promiseDone")(d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchGetFTSNextTimestamp",{threadId:g}).then(function(a){var c=(h||(h=d("I64"))).to_float(e);if(!d("MAWFTSRestoreCap").isRestoreTimeWithinCap(c))return;if(!b.$1.has(g)){b.$1.set(g,c);c=a!=null&&!d("MAWFTSRestoreCap").isRestoreTimeWithinCap(parseInt(a,10));d("MAWFTSRestoreSyncLogger").incrementTotalResultCount(c)}if(a==="0")return;b.$2.add(d("WAJids").unsafeCoerceToChatJid(g));return d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchSetFTSNextTimestamp",{newSortOrderMs:h.to_string(e),threadId:g})})["finally"](function(){b.$7["delete"](g),b.$7.size===0&&!b.$6&&d("MAWFTSRestoreSyncLogger").onFetchThreadsComplete()}))};e.$9=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=this,b=(yield this.$12());b=d("ReQL").fromTableAscending(b.tables.messenger_fts_threads,["threadId","nextMessageTimestamp","threadType"]);b.subscribe(function(b,c){c.operation==="add"&&a.$13(c.value)});b=(yield d("ReQL").toArrayAsync(b));b.forEach(function(b){a.$13(b)})});function c(){return a.apply(this,arguments)}return c}();e.$12=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){this.$3==null&&(this.$3=(yield (i||(i=d("LSDatabaseSingleton"))).LSDatabaseSingleton));return this.$3});function c(){return a.apply(this,arguments)}return c}();return a}();function a(){j==null&&(j=new k());return j}g.MAWFTSThreadsRestore=k;g.getInstance=a}),98);
__d("MWXCard.react",["cr:8789","react"],(function(a,b,c,d,e,f,g){"use strict";var h,i=(h||(h=d("react"))).c,j=h;function a(a){var c=i(2),d;c[0]!==a?(d=j.jsx(b("cr:8789"),babelHelpers["extends"]({},a)),c[0]=a,c[1]=d):d=c[1];return d}g["default"]=a}),98);
__d("useMWMediaGalleryRestoreStatus",["Int64Hooks","LSMessagingThreadTypeUtil","MAWFTSRestoreSync","MAWMiActOnActThreadReady","MWEBEntrypointsKillswitch.enum","MWInboxMessageSearchStatusTypes","Promise","asyncToGeneratorRuntime","cr:11999","justknobx","react","useMWEBBackupState","useReStore"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;e=j||d("react");var k=e.useState,l=e.c;function a(a){var e=l(9),f=a.threadKey;a=a.threadType;var g=(i||(i=c("useReStore")))(),j=k(null),m=j[0],n=j[1];e[0]===Symbol["for"]("react.memo_cache_sentinel")?(j={entrypoint:c("MWEBEntrypointsKillswitch.enum").MEDIA_GALLERY_RESTORE},e[0]=j):j=e[0];j=c("useMWEBBackupState")(j);var o=b("cr:11999")(m);a=d("LSMessagingThreadTypeUtil").isArmadilloSecure(a);var p;e[1]===Symbol["for"]("react.memo_cache_sentinel")?(p=d("MAWFTSRestoreSync").getFTSRestoreSync(),e[1]=p):p=e[1];var q=p;e[2]===Symbol["for"]("react.memo_cache_sentinel")?(p=function(){return q.isStarted()},e[2]=p):p=e[2];p=k(p);var r=p[0],s=p[1];e[3]===Symbol["for"]("react.memo_cache_sentinel")?(p=function(){return q.isEBMaybeAvailable()},e[3]=p):p=e[3];p=k(p);var t=p[0],u=p[1];e[4]===Symbol["for"]("react.memo_cache_sentinel")?(p=function(){return q.getActiveThreadId()},e[4]=p):p=e[4];p=k(p);var v=p[0],w=p[1];p=k(-1);var x=p[0],y=p[1];p=k(!1);var z=p[0],A=p[1],B;e[5]!==g.tables||e[6]!==f?(p=function(){var a;(a=d("MAWFTSRestoreSync")).MAWGalleryEventEmitter.addListener("isSyncStarted",function(a){return s(a)});a.MAWGalleryEventEmitter.addListener("isEBMaybeAvailable",function(a){return u(a)});a.MAWGalleryEventEmitter.addListener("activeThreadJid",function(a){return w(a)});a.MAWGalleryEventEmitter.addListener("isPersisting",function(a){return A(a)});a.MAWGalleryEventEmitter.addListener("restoredUntilMs",function(a){a=a!=null?parseInt(a,10):-1;y(a)});a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield d("MAWMiActOnActThreadReady").onActThreadReady(g.tables,f,"useThreadJid",function(a,c){n(c);return(h||(h=b("Promise"))).resolve()})});function c(){return a.apply(this,arguments)}return c}();a()["catch"](function(){});return function(){d("MAWFTSRestoreSync").MAWGalleryEventEmitter.removeAllListeners()}},B=[g.tables,f],e[5]=g.tables,e[6]=f,e[7]=p,e[8]=B):(p=e[7],B=e[8]);d("Int64Hooks").useEffectInt64(p,B);if(m!=null&&q.getDoneThreads().has(m))return d("MWInboxMessageSearchStatusTypes").RestoreStatus.COMPLETE;e=v===m;if(!a)return d("MWInboxMessageSearchStatusTypes").RestoreStatus.NOT_REQUIRED;if(j!==3)return d("MWInboxMessageSearchStatusTypes").RestoreStatus.NOT_RUNNING;if(r){if(!t||!e)return d("MWInboxMessageSearchStatusTypes").RestoreStatus.NOT_RUNNING;p=c("justknobx")._("3245")?x===0:o===0;return p&&!z?d("MWInboxMessageSearchStatusTypes").RestoreStatus.COMPLETE:d("MWInboxMessageSearchStatusTypes").RestoreStatus.IN_PROGRESS}else return d("MWInboxMessageSearchStatusTypes").RestoreStatus.NOT_RUNNING}g["default"]=a}),98);
;/*FB_PKG_DELIM*/

__d("EBAPISharedUtils",["EBAPIQPLPoints","LSDeleteAndReenrollDeviceStateStoredProcedure","LSFactory","LSIntEnum","LSMEBDeviceReenrollmentReason","QPLUserFlow","WALogger","asyncToGeneratorRuntime","handleRestoreMessagesGraphQLResponse"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] backup_id is null during graphQL restore"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] message range info is not complete - cannot proceed with graphQL restore"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] message range info is null - cannot proceed with graphQL restore"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Deleting mailbox - unable to restore"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] GQL worker range restore query returned null for message response"]);m=function(){return a};return a}function a(a,b,c,d,e,f,g,h,i){return n.apply(this,arguments)}function n(){n=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,g,n,o,p,q,r){var s;c("QPLUserFlow").addPoint(b,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_END,{instanceKey:g});if(a==null||(a==null?void 0:(s=a.viewer)==null?void 0:(s=s.encrypted_backup)==null?void 0:s.mailbox)==null){c("QPLUserFlow").endFailure(b,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{instanceKey:g});return{response:"invalid-graphql-response",success:!1}}a=a==null?void 0:(s=a.viewer)==null?void 0:(a=s.encrypted_backup)==null?void 0:(s=a.mailbox)==null?void 0:s.messages;if(a==null){d("WALogger").ERROR(m());c("QPLUserFlow").endFailure(b,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{instanceKey:g});return{response:"invalid-graphql-response",success:!1}}s=a;if(s==null){c("QPLUserFlow").endFailure(b,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{instanceKey:g});return{response:"invalid-graphql-response",success:!1}}a=s.backup_id;var t=s.encrypted_messages,u=s.epoch_derivation_set,v=s.message_range_info;s=s.should_delete_mailbox;if(s===!0){d("WALogger").WARN(l());c("QPLUserFlow").endFailure(b,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DELETE_MAILBOX,{instanceKey:g});yield e.runInTransaction(function(a){return c("LSDeleteAndReenrollDeviceStateStoredProcedure")(c("LSFactory")(a),{reenrollmentReason:(h||(h=d("LSIntEnum"))).ofNumber(c("LSMEBDeviceReenrollmentReason").RESTORE_FAILED_WITH_NO_DEVICE_FOUND),targetDeviceId:n})},"readwrite",void 0,void 0,f.id+":110");return{response:"delete-mailbox",success:!1}}c("QPLUserFlow").addPoint(b,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_START,{instanceKey:g});yield d("handleRestoreMessagesGraphQLResponse").deriveAndStoreEpochs(u,e,n,q);c("QPLUserFlow").addPoint(b,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_END,{instanceKey:g});if(v==null){d("WALogger").ERROR(k());c("QPLUserFlow").endFailure(b,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{instanceKey:g});return{response:"invalid-graphql-response",success:!1}}s=v.has_more_after;u=v.has_more_before;var w=v.next_message_timestamp_ms_after,x=v.next_message_timestamp_ms_before;if(u==null||s==null||w==null||x==null){d("WALogger").ERROR(j());c("QPLUserFlow").endFailure(b,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{instanceKey:g});return{response:"invalid-graphql-response",success:!1}}a==null&&(d("WALogger").WARN(i()),c("QPLUserFlow").addPoint(b,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.BACKUP_ID_NULL,{instanceKey:g}));c("QPLUserFlow").addPoint(b,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.PROCESS_AND_DECRYPT_MESSAGES_START,{instanceKey:g});u=(yield d("handleRestoreMessagesGraphQLResponse").processEncryptedMessagesForSearch({backupId:a,encryptedMessages:t,messageRangeInfo:v,sortOrderMs:r,source:p,storage:e,threadId:o,traceId:q}));c("QPLUserFlow").addPoint(b,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.PROCESS_AND_DECRYPT_MESSAGES_END,{instanceKey:g});if(u==null){c("QPLUserFlow").endFailure(b,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.EMPTY_DECRYPTION_RESPONSE,{instanceKey:g});return{response:"empty-decryption-response",success:!1}}c("QPLUserFlow").endSuccess(b,{annotations:{bool:{isEcho:(u==null?void 0:u.echoMessages)?(u==null?void 0:u.echoMessages.length)>0:!1,isProtobuf:(u==null?void 0:u.protobufMessages)?(u==null?void 0:u.protobufMessages.length)>0:!1}},instanceKey:g});return{response:u,success:!0}});return n.apply(this,arguments)}g.constructEBRestoreResponse=a}),98);
__d("EBMessageRangeQuery",["EBAPIQPLPoints","EBAPISharedUtils","EBAPIWorkerCheck","I64","LSDatabaseSingleton","LSEncryptedBackupsMessagesRangeQueryDirection","MAWCurrentUser","MAWEncryptedBackupsRestoreMessageOverGraphQL","MAWJobDefinitions","QPLUserFlow","WABase64","WAHashStringToNumber","WAJids","WALogger","WAResultOrError","WorkerRelay","asyncToGeneratorRuntime","gkx","handleRestoreMessagesGraphQLResponse","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] graphQL range restore error ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] mandatory params of client state are null"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] No client state found - unable to restore"]);l=function(){return a};return a}function a(a){return m.apply(this,arguments)}function m(){m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.chatJid,e=a.direction,f=a.instanceKey,g=a.sortOrderMs;a=a.source;if(d("EBAPIWorkerCheck").runningInWorker())return d("WAResultOrError").makeError("unsupported-context");f=f!=null?d("WAHashStringToNumber").hashStringToNumber(f):void 0;var m=c("qpl")._(521471755,"2586");try{c("QPLUserFlow").start(m,{annotations:{bool:{mainThreadRestore:!0,workerThreadRestore:!1}},instanceKey:f});var n=(yield (h||(h=d("LSDatabaseSingleton"))).LSDatabaseSingleton),o=(yield d("handleRestoreMessagesGraphQLResponse").getClientState(n));if(o==null){d("WALogger").ERROR(l());c("QPLUserFlow").endFailure(m,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE,{instanceKey:f});return d("WAResultOrError").makeError("no-client-state")}var p=o.device_id,q=o.locally_available_epochs,r=o.mailboxRootKey;o=o.ocmfClientStateBlob;if(p==null||r==null||o==null){d("WALogger").ERROR(k());c("QPLUserFlow").endFailure(m,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE,{instanceKey:f});return d("WAResultOrError").makeError("invalid-client-state")}var s=d("MAWCurrentUser").getAppID();b=d("WAJids").threadIdForChatJid(b);e=e==="before"?c("LSEncryptedBackupsMessagesRangeQueryDirection").BEFORE:c("LSEncryptedBackupsMessagesRangeQueryDirection").AFTER;q={restore_context:{act_thread_id:d("MAWJobDefinitions").toThreadJidPrimaryId(b),site:"www",tam_thread_subtype:0},success:{device_context:{device_id:(i||(i=d("I64"))).to_float(p),locally_available_epochs:q,raw_tokens:{mailbox_root_key:d("WABase64").encodeB64(r),ocmf_client_state_blob:d("WABase64").encodeB64(o)}},direction:e,include_offset:c("gkx")("5340"),server_thread_key:b}};g!=null&&(q=babelHelpers["extends"]({},q,{reference_timestamp:g}));c("QPLUserFlow").addPoint(m,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_START,{instanceKey:f});o=(yield d("WorkerRelay").createWorkerQuery(d("MAWEncryptedBackupsRestoreMessageOverGraphQL").query,{app_id:String((r=s)!=null?r:"0"),restore_payload_string:JSON.stringify(q),restore_type:"RANGE_QUERY_RESTORE"}));e=(yield d("EBAPISharedUtils").constructEBRestoreResponse(o,m,n,f,p,b,a,void 0,g));if(e.success)return d("WAResultOrError").makeResult(e.response);else return d("WAResultOrError").makeError(e.response)}catch(a){d("WALogger").ERROR(j(),a);c("QPLUserFlow").endFailure(m,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.RUNTIME_ERROR,{error:a,instanceKey:f});return d("WAResultOrError").makeError("runtime-error",a)}});return m.apply(this,arguments)}g.messageRangeQuery=a}),98);